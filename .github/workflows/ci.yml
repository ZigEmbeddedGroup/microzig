name: CI
on:
  push:
    branches: [main, zig-master]
  pull_request:
    branches: [main, zig-master]

jobs:
  common-setup:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [
          ubuntu-latest,
          windows-latest,
          macos-latest,
        ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v1
        with:
          version: ${{ github.ref == 'refs/heads/zig-master' && 'master' || '0.13.0' }}

  build:
    runs-on: ${{ matrix.os }}
    needs: common-setup
    continue-on-error: true
    steps:
      - name: Build
        run: zig build -Doptimize=ReleaseSmall

  unit-test-ports:
    runs-on: ${{ matrix.os }}
    needs: common-setup
    strategy:
      matrix:
        os: [
          ubuntu-latest,
          windows-latest,
          macos-latest,
        ]
        port_dir: [
          gigadevice/gd32,
          raspberrypi/rp2xxx,
          stmicro/stm32,
        ]
    steps:
      - name: Unit Test Ports
        run: zig build test
        working-directory: port/${{ matrix.port_dir }}

  unit-test-regz:
    runs-on: ${{ matrix.os }}
    needs: common-setup
    steps:
      - name: Unit Test Regz
        run: zig build test
        working-directory: tools/regz

  unit-test-uf2:
    runs-on: ${{ matrix.os }}
    needs: common-setup
    steps:
      - name: Unit Test UF2
        run: zig build test
        working-directory: tools/uf2

  build-website:
    runs-on: ${{ matrix.os }}
    needs: common-setup
    steps:
      - name: Build Website
        run: zig build
        working-directory: website

  dry-run-packaging:
    runs-on: macos-latest
    needs: common-setup
    steps:
      - name: Dry Run Packaging
        run: |
          MICROZIG_VERSION=$(zig build package -- get-version)
          echo microzig version: $MICROZIG_VERSION
          zig build package -- http://localhost:8000
          python3 -m http.server 8000 --directory boxzer-out &
          sleep 1

          cd tools/package-test
          zig fetch --save=microzig http://localhost:8000/${MICROZIG_VERSION}/microzig.tar.gz
          zig build -Doptimize=ReleaseSmall

          jobs -p | xargs kill

  build-examples:
    runs-on: ubuntu-latest
    needs: common-setup
    continue-on-error: true
    strategy:
      matrix:
        example_dir: [
          espressif/esp,
          gigadevice/gd32,
          microchip/avr,
          microchip/atsam,
          nordic/nrf5x,
          nxp/lpc,
          stmicro/stm32,
          raspberrypi/rp2xxx,
          wch/ch32v,
        ]
    steps:
      - name: Build Examples
        run: zig build -Doptimize=ReleaseSmall --summary all
        working-directory: examples/${{ matrix.example_dir }}

