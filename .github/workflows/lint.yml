name: Code Linting

on:
  pull_request_target: # Changed from pull_request
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Changed from write - only read needed
      pull-requests: write

    steps:
      # SECURITY: Checkout base branch for linter binary
      - name: Checkout base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }} # Checkout base, not PR code
          path: base

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      # Build linter from trusted base branch code
      - name: Build linter
        working-directory: base/tools/linter
        run: zig build --release=safe

      # Now checkout PR code to analyze (but not execute)
      - name: Checkout PR code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: pr
          fetch-depth: 0

      - name: Run linter
        working-directory: pr
        run: |
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"

          # Get changed .zig files
          FILES=$(git diff --name-only --diff-filter=d ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep '\.zig$' || true)
          echo "Changed files: $FILES"

          if [ -n "$FILES" ]; then
            echo "$FILES" | xargs ../base/tools/linter/zig-out/bin/linter > lint_results_raw.json
          else
            echo "[]" > lint_results_raw.json
          fi

          echo "Raw lint results:"
          cat lint_results_raw.json

      - name: Filter lint results to changed lines
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Change to pr directory
            process.chdir('pr');

            if (!fs.existsSync('lint_results_raw.json')) {
              fs.writeFileSync('lint_results.json', '[]');
              console.log('No raw lint results found');
              return;
            }

            const rawIssues = JSON.parse(fs.readFileSync('lint_results_raw.json', 'utf8'));

            if (rawIssues.length === 0) {
              fs.writeFileSync('lint_results.json', '[]');
              console.log('No lint issues found');
              return;
            }

            console.log(`Found ${rawIssues.length} total lint issue(s)`);

            const baseSha = '${{ github.event.pull_request.base.sha }}';
            const headSha = '${{ github.event.pull_request.head.sha }}';

            const changedLines = {};

            for (const issue of rawIssues) {
              const file = issue.file;

              if (!changedLines[file]) {
                try {
                  const diff = execSync(
                    `git diff --unified=0 ${baseSha} ${headSha} -- "${file}"`,
                    { encoding: 'utf8' }
                  );

                  const lines = new Set();
                  const diffLines = diff.split('\n');

                  for (const line of diffLines) {
                    const match = line.match(/^@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@/);
                    if (match) {
                      const startLine = parseInt(match[1]);
                      const count = match[2] ? parseInt(match[2]) : 1;

                      for (let i = 0; i < count; i++) {
                        lines.add(startLine + i);
                      }
                    }
                  }

                  changedLines[file] = lines;
                  console.log(`File ${file}: ${lines.size} changed line(s)`);
                } catch (error) {
                  console.log(`Could not get diff for ${file}: ${error.message}`);
                  changedLines[file] = new Set();
                }
              }
            }

            const filteredIssues = rawIssues.filter(issue => {
              const fileLines = changedLines[issue.file] || new Set();
              const isOnChangedLine = fileLines.has(issue.line);
              if (!isOnChangedLine) {
                console.log(`Filtered out: ${issue.file}:${issue.line} (not on changed line)`);
              }
              return isOnChangedLine;
            });

            fs.writeFileSync('lint_results.json', JSON.stringify(filteredIssues, null, 2));

            const filtered = rawIssues.length - filteredIssues.length;
            if (filtered > 0) {
              console.log(`Filtered out ${filtered} issue(s) on unchanged lines`);

              const filteredOut = rawIssues.filter(issue => !filteredIssues.includes(issue));
              const summary = filteredOut.map(i => `${i.file}:${i.line}: ${i.message}`).join('\n');
              fs.writeFileSync('filtered_issues.txt', 
                `The following ${filtered} issue(s) exist but are not on lines changed in this PR:\n\n${summary}`
              );
            }

            console.log(`Kept ${filteredIssues.length} issue(s) on changed lines for inline comments`);

      - name: Post review with grouped comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const crypto = require('crypto');

            // Change to pr directory
            process.chdir('pr');

            // [Rest of your review posting script remains the same]
            // ... (keeping your existing code here)
